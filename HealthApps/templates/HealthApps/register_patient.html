{% extends 'HealthApps/base.html' %}

{% load staticfiles %}
{% block content %}

<div class="container">
    <h1>Patient Registration</h1>
    <ul class="nav nav-tabs" id="registerTab">
        <li class="active"><a data-toggle="tab" href="#step1">Insurance</a></li>
        <li class="disabled"><a data-toggle="" href="#step2">Account Info</a></li>
        <li class="disabled"><a data-toggle="" href="#step3">Hospital Info</a></li>
        <li class="disabled"><a data-toggle="" href="#step4">Medical Info (Optional)</a></li>
        <li class="disabled"><a data-toggle="" href="#step5">Emergency Info</a></li>
    </ul>

    <form id="reg_form" enctype="multipart/form-data" action="" method="post">{% csrf_token %}
        <fieldset>
            <div class="tab-content">
                <div id="step1" class="tab-pane fade in active">
                    <div class="form-group">
                        <label class="form-control-label" for="insurance">Insurance Number (One capital letter followed
                            by 12 alphanumeric characters)</label>
                        <input name="insurance_number" type="text" id="insurance"
                               placeholder="Enter Insurance Number" class="form-control">
                        <div><a href="https://www.healthcare.gov/" target="_blank">Don't have insurance?</a></div>
                        <div>{{ form.insurance_number.errors.as_text }}</div>
                    </div>

                    <button class="btn btn-primary btnNext" type="button" onclick="return showNext()">Next</button>
                </div>

                <div id="step2" class="tab-pane fade">
                    <div class="form-group">
                        <label class="form-control-label" for="first_name">First Name</label>
                        <input name="first_name" id="first_name" type="text" class="form-control"
                               placeholder="Enter First Name">
                        <p>{{ form.first_name.errors.as_text }}</p>
                    </div>

                    <div class="form-group">
                        <label class="form-control-label" for="last_name">Last Name</label>
                        <input name="last_name" type="text" id="last_name" class="form-control"
                               placeholder="Enter Last Name">
                        <p>{{ form.last_name.errors.as_text }}</p>
                    </div>

                    <div class="form-group">
                        <label class="form-control-label" for="username">Email Address</label>
                        <input name="username" type="email" id="username" class="form-control"
                               placeholder="Enter Email Address">
                        <p>{{ form.username.errors.as_text }}</p>
                    </div>

                    <div class="form-group">
                        <label class="form-control-label" for="password">Password</label>
                        <input name="password" type="password" id="password" class="form-control"
                               placeholder="Enter Password">
                        <p>{{ form.password.errors.as_text }}</p>
                    </div>

                    <div class="form-group">
                        <label class="form-control-label" for="password_confirm">Confirm Password</label>
                        <input name="password_confirm" id="password_confirm" class="form-control"
                               type="password" placeholder="Re-enter Password">
                        <p>{{ form.password_confirm.errors.as_text }}</p>
                    </div>
                    <button class="btn btn-primary btnPrev" type="button" onclick="return showPrev()">Previous</button>
                    <button class="btn btn-primary btnNext" type="button" onclick="return showNext()">Next</button>

                </div>

                <div id="step3" class="tab-pane fade">
                    <div class="form-group">
                        <label class="form-control-label" for="hospital">Hospital</label>
                        <select id="hospital" class="form-control" name="hospital">
                            {% for value, text in form.fields.hospital.choices %}

                            <option value="{{ value }}">{{ text }}</option>

                            {% endfor %}
                        </select>
                        <p>{{ form.hospital.errors.as_text }}</p>
                    </div>

                    <div class="form-group">
                        <label class="form-control-label" for="doctor">Doctor</label>
                        <select id="doctor" class="form-control" name="doctor">
                            <!--{% for value, text in form.fields.doctor.choices %}-->
                            <!--<option value="{{ value }}">{{ text }}</option>-->
                            <!--{% endfor %}-->
                        </select>
                        <p>{{ form.doctor.errors.as_text }}</p>
                    </div>
                    <button class="btn btn-primary btnPrev" type="button" onclick="return showPrev()">Previous</button>
                    <button class="btn btn-primary btnNext" type="button" onclick="return showNext()">Next</button>

                </div>

                <div id="step4" class="tab-pane fade">
                    <div class="form-group">
                        <label class="form-control-label" for="height">Height (in.)</label>
                        <input name="height" type="number" min=6 max=108 id="height" class="form-control"
                               placeholder="Enter Height">
                        <p>{{ form.height.errors.as_text }}</p>
                    </div>

                    <div class="form-group">
                        <label class="form-control-label" for="weight">Weight (lbs)</label>
                        <input name="weight" type="number" min=0.5 max=1500 id="weight" class="form-control"
                               placeholder="Enter Weight">
                        <p>{{ form.weight.errors.as_text }}</p>
                    </div>

                    <div class="form-group">
                        <label class="form-control-label" for="cholesterol">Cholesterol (LDL/HDL in mg/dL)</label>
                        <input name="cholesterol" type="text" id="cholesterol" class="form-control"
                               placeholder="Enter Cholesterol">
                        <p>{{ form.cholesterol.errors.as_text }}</p>
                    </div>

                    <div class="form-group">
                        <label class="form-control-label" for="pulse">Pulse (BPM)</label>
                        <input name="pulse" type="number" min=25 max=250 id="pulse" class="form-control"
                               placeholder="Enter Pulse">
                        <p>{{ form.pulse.errors.as_text }}</p>
                    </div>

                    <div class="form-group">
                        <label class="form-control-label" for="temperature">Temperature (Fahrenheit)</label>
                        <input name="temperature" type="number" min=55 max=120 id="temperature" class="form-control"
                               placeholder="Enter Temperature">
                        <p>{{ form.temperature.errors.as_text }}</p>
                    </div>

                    <div class="form-group">
                        <label class="form-control-label" for="blood_pressure">Blood Pressure (Systolic/Diastolic in mm
                            HG)</label>
                        <input name="blood_pressure" type="text" id="blood_pressure" class="form-control"
                               placeholder="Enter Blood Pressure">
                        <p>{{ form.blood_pressure.errors.as_text }}</p>
                    </div>

                    <div class="form-group">
                        <label class="form-control-label" for="blood_type">Blood Type</label>
                        <select id="blood_type" class="form-control" name="blood_type">
                            {% for value, text in form.fields.blood_type.choices %}

                            <option value="{{ value }}">{{ text }}</option>

                            {% endfor %}
                        </select>
                    </div>

                    <button class="btn btn-primary btnPrev" type="button" onclick="return showPrev()">Previous</button>
                    <button class="btn btn-primary btnNext" type="button" onclick="return showNext()">Next</button>
                </div>

                <div id="step5" class="tab-pane fade">
                    <div class="form-group">
                        <label class="form-control-label" for="emergency_name">Emergency Name</label>
                        <input name="emergency_name" type="text" id="emergency_name" class="form-control"
                               placeholder="Enter Emergency Name">
                        <p>{{ form.emergency_name.errors.as_text }}</p>
                    </div>

                    <div class="form-group">
                        <label class="form-control-label" for="emergency_number">Emergency Number</label>
                        <input name="emergency_number" type="text" id="emergency_number" class="form-control"
                               placeholder="Enter Emergency number">
                        <p>{{ form.emergency_number.errors.as_text }}</p>
                    </div>

                    <div class="form-group">
                        <button class="btn btn-primary btnPrev" type="button" onclick="return showPrev()">Previous
                        </button>
                        <input type="submit" value="Submit" class="btn btn-success"/>
                    </div>
                </div>
            </div>
            <br/>
            <a class="btn btn-danger btnCancel" href="index.html">Cancel</a>

        </fieldset>
    </form>


</div>

<script src="http://cdn.jsdelivr.net/jquery.validation/1.15.1/jquery.validate.js"></script>

<script type="text/javascript">
    $.validator.setDefaults({
        highlight: function (element) {
            $(element).closest('.form-group').addClass('has-error');
            $(element).closest('.form-group').removeClass('has-success');
        },
        unhighlight: function (element) {
            $(element).closest('.form-group').removeClass('has-error');
            $(element).closest('.form-group').addClass('has-success');
        },
        errorElement: 'span',
        errorClass: 'help-block',
        errorPlacement: function (error, element) {
            if (element.parent('.input-group').length) {
                error.insertAfter(element.parent());
            } else {
                error.insertAfter(element);
            }
        }
    });

    var $tabs = $('#registerTab').find('li');

    function showPrev() {
        $tabs.filter('.active').prev('li').removeClass("disabled");
        $tabs.filter('.active').prev('li').find('a[data-toggle]').each(function () {
            $(this).attr("data-toggle", "tab");
        });

        $tabs.filter('.active').prev('li').find('a[data-toggle="tab"]').tab('show');

        $tabs.filter('.active').next('li').find('a[data-toggle="tab"]').each(function () {
            $(this).attr("data-toggle", "").parent('li').addClass("disabled");
        })
    }

    function showNext() {
        if ($('#reg_form').valid()) {
            $tabs.filter('.active').next('li').removeClass("disabled");
            $tabs.filter('.active').next('li').find('a[data-toggle]').each(function () {
                $(this).attr("data-toggle", "tab");
            });

            $tabs.filter('.active').next('li').find('a[data-toggle="tab"]').tab('show');

            $tabs.filter('.active').prev('li').find('a[data-toggle="tab"]').each(function () {
                $(this).attr("data-toggle", "").parent('li').addClass("disabled");
            })
        }
    }

    function json_to_select(url, select_selector) {
        /*
         Fill a select input field with data from a getJSON call
         Inspired by: http://stackoverflow.com/questions/3233850/django-jquery-cascading-select-boxes
         */
        $.getJSON(url, function (data) {
            var opt = $(select_selector);
            var old_val = opt.val();
            opt.html('');
            $.each(data, function () {
                opt.append($('<option/>').val(this.id).text(this.value));
            });
            opt.val(old_val);
            opt.change();
        })
    }

    FORM_RULES = {
        '{{ form.insurance_number.name }}': 'required INSURANCE',
        '{{ form.first_name.name }}': 'required',
        '{{ form.last_name.name }}': 'required',
        '{{ form.username.name }}': 'required EMAIL',
        '{{ form.password.name }}': 'required',
        '{{ form.password_confirm.name }}': 'required PASSMATCH',
        '{{ form.hospital.name }}': 'required',
        '{{ form.doctor.name }}': 'required',
        '{{ form.cholesterol.name }}': 'CHOLESTEROL',
        '{{ form.blood_pressure.name }}': 'BLOOD_PRESSURE',
        '{{ form.emergency_name.name }}': 'required',
        '{{ form.emergency_number.name }}': 'required EMERGENCY_NUMBER'
    };

    $(document).ready(function () {
        $.validator.addMethod("INSURANCE", function (value, element) {
                return this.optional(element) || /^[A-Z]\w{12}$/.test(value);
            }, "Insurance Number Format: One capital letter followed by 12 alphanumeric characters. (Ex: A12Z45f78s012)"
        );

        $.validator.addMethod("EMAIL", function (value, element) {
                return this.optional(element) || /^[a-zA-Z0-9._-]+@[a-zA-Z0-9-]+\.[a-zA-Z.]{2,5}$/i.test(value);
            }, "Email Address is invalid: Please enter a valid email address."
        );

        $.validator.addMethod("CHOLESTEROL", function (value, element) {
                return this.optional(element) || /^(9[0-9]|1[0-9][0-9]|200)\/(100|2[5-9]|[3-9][0-9])$/i.test(value);
            }, "Please input a valid LDL/HDL. LDL must be between 90 and 200, HDL must be between 25 and 100."
        );

        $.validator.addMethod("BLOOD_PRESSURE", function (value, element) {
            return this.optional(element) || /^(180|1[0-7][0-9])\/(120|[6-9][0-9]|1[0-1][0-9])$/i.test(value);
        }, "Please input a valid Systolic/Diastolic blood pressure. " +
            "Systolic must be between 100 and 180, Diastolic must be between 60 and 120."
        );

        $.validator.addMethod("EMERGENCY_NUMBER", function (value, element) {
                return /^(\(\d{3}\)|\d{3})?[- \.]?(\d{3})[- \.]?(\d{4})$/i.test(value);
            }, "Please input a valid phone number."
        );

        $.validator.addMethod("PASSMATCH", function (value, element) {
                var password = $("#password").val();
                var password_confirm = $("#password_confirm").val();
                return this.optional(element) || password == password_confirm;
            }, "Passwords do not match."
        );

        $('#reg_form').validate({
            rules: FORM_RULES
        });

        $("a[href='#step3']").on('shown.bs.tab', function (e) {
            json_to_select('/cascade_select/hospital-to-doctor/?hospital=' + $('#hospital').val(), '#doctor');
        });

        $('#hospital').change(function () {
            json_to_select('/cascade_select/hospital-to-doctor/?hospital=' + $(this).val(), '#doctor');
        })
    });
</script>
{% endblock %}